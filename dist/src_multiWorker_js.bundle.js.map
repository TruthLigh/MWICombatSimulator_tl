{"version":3,"file":"src_multiWorker_js.bundle.js","mappings":";;;UAAA;UACA;;UAEA;UACA;;;;;WCJA;WACA;WACA;WACA;WACA;;;;;WCJA;WACA;WACA;WACA;WACA,GAAG;WACH;WACA;WACA,CAAC;;;;;WCPD;;;;;WCAA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;WACA;;;;;WClBA;;WAEA;WACA;WACA;WACA;WACA;;WAEA;WACA;;WAEA;;WAEA;;;;;;;;ACZA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,oEAAoE,2FAA4B;;AAEhG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kCAAkC;AAClC;AACA;AACA,+DAA+D,sDAAsD;AACrH,kCAAkC;AAClC;AACA;AACA;AACA,yBAAyB;;AAEzB;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA,mCAAmC,yDAAyD;AAC5F,cAAc;AACd;AACA,mCAAmC,oCAAoC;AACvE;AACA;AACA;AACA,E","sources":["webpack://mwicombatsimulator/webpack/bootstrap","webpack://mwicombatsimulator/webpack/runtime/get javascript chunk filename","webpack://mwicombatsimulator/webpack/runtime/global","webpack://mwicombatsimulator/webpack/runtime/hasOwnProperty shorthand","webpack://mwicombatsimulator/webpack/runtime/publicPath","webpack://mwicombatsimulator/webpack/runtime/importScripts chunk loading","webpack://mwicombatsimulator/./src/multiWorker.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n// expose the modules object (__webpack_modules__)\n__webpack_require__.m = __webpack_modules__;\n\n","// This function allow to reference async chunks\n__webpack_require__.u = (chunkId) => {\n\t// return url for filenames based on template\n\treturn \"\" + chunkId + \".bundle.js\";\n};","__webpack_require__.g = (function() {\n\tif (typeof globalThis === 'object') return globalThis;\n\ttry {\n\t\treturn this || new Function('return this')();\n\t} catch (e) {\n\t\tif (typeof window === 'object') return window;\n\t}\n})();","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","var scriptUrl;\nif (__webpack_require__.g.importScripts) scriptUrl = __webpack_require__.g.location + \"\";\nvar document = __webpack_require__.g.document;\nif (!scriptUrl && document) {\n\tif (document.currentScript)\n\t\tscriptUrl = document.currentScript.src;\n\tif (!scriptUrl) {\n\t\tvar scripts = document.getElementsByTagName(\"script\");\n\t\tif(scripts.length) {\n\t\t\tvar i = scripts.length - 1;\n\t\t\twhile (i > -1 && (!scriptUrl || !/^http(s?):/.test(scriptUrl))) scriptUrl = scripts[i--].src;\n\t\t}\n\t}\n}\n// When supporting browsers where an automatic publicPath is not supported you must specify an output.publicPath manually via configuration\n// or pass an empty string (\"\") and set the __webpack_public_path__ variable from your code to use your own logic.\nif (!scriptUrl) throw new Error(\"Automatic publicPath is not supported in this browser\");\nscriptUrl = scriptUrl.replace(/#.*$/, \"\").replace(/\\?.*$/, \"\").replace(/\\/[^\\/]+$/, \"/\");\n__webpack_require__.p = scriptUrl;","__webpack_require__.b = self.location + \"\";\n\n// object to store loaded chunks\n// \"1\" means \"already loaded\"\nvar installedChunks = {\n\t\"src_multiWorker_js\": 1\n};\n\n// no chunk install function needed\n// no chunk loading\n\n// no HMR\n\n// no HMR manifest","\nonmessage = async function (event) {\n    switch (event.data.type) {\n        case \"start_simulation_all_zones\":\n            const zoneHrids = event.data.zones;\n            let zoneProgress = Object.fromEntries(zoneHrids.map(zone => [zone, 0]));\n\n            try {\n                const maxWorkers = navigator.hardwareConcurrency;\n                console.log(\"maxWorkers: \" + maxWorkers);\n\n                const taskQueue = [...zoneHrids];\n                const results = new Array(zoneHrids.length);\n                const outer_worker = this;\n\n                // 创建工作线程池\n                const processTask = async (workerId) => {\n                    while (taskQueue.length > 0) {\n                        const zoneIndex = zoneHrids.length - taskQueue.length;\n                        const currentZone = taskQueue.shift();\n\n                        const simulationWorker = new Worker(new URL('worker.js', import.meta.url));\n\n                        // Do simulation\n                        let workerMessage = {\n                            type: \"start_simulation\",\n                            players: event.data.players,\n                            zoneHrid: currentZone,\n                            simulationTimeLimit: event.data.simulationTimeLimit,\n                        };\n                        simulationWorker.postMessage(workerMessage);\n                        \n                        const result = await new Promise((resolve, reject) => {\n                            simulationWorker.onmessage = function (event) {\n                                if (event.data.type === \"simulation_result\") {\n                                    resolve(event.data.simResult);\n                                } else if (event.data.type === \"simulation_progress\") {\n                                    zoneProgress[event.data.zone] = event.data.progress;\n                                    let totalProgress = Object.values(zoneProgress).reduce((acc, progress) => acc + progress, 0) / Object.keys(zoneProgress).length;\n                                    outer_worker.postMessage({ type: \"simulation_progress\", progress: totalProgress });\n                                } else if (event.data.type === \"simulation_error\") {\n                                    reject(event.data.error);\n                                }\n                            };\n                        });\n\n                        results[zoneIndex] = result;\n                        simulationWorker.terminate();\n                    }\n                };\n\n                // 启动工作线程\n                const workers = Array(Math.min(maxWorkers, zoneHrids.length))\n                    .fill()\n                    .map((_, index) => processTask(index));\n\n                // 等待所有任务完成\n                await Promise.all(workers);\n\n                this.postMessage({ type: \"simulation_result_allZones\", simResults: results });\n            } catch (e) {\n                console.log(e);\n                this.postMessage({ type: \"simulation_error\", error: e });\n            }\n            break;\n    }\n};"],"names":[],"sourceRoot":""}